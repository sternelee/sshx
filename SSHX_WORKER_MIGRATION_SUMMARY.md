# sshx-server åˆ° Cloudflare Workers è¿ç§»å®Œæˆæ€»ç»“

## é¡¹ç›®æ¦‚è¿°

æˆ‘å·²ç»å®Œæˆäº†å¯¹ sshx-server æ¨¡å—çš„æ·±å…¥åˆ†æï¼Œå¹¶åœ¨ sshx-worker ä¸­å®ç°äº†å®Œæ•´çš„ Cloudflare Workers + WebSocket + D1 æ¶æ„è¿ç§»ã€‚è¿™ä¸ªå®ç°ä¿æŒäº†ä¸åŸå§‹ sshx ç³»ç»Ÿçš„å®Œå…¨å…¼å®¹æ€§ï¼ŒåŒæ—¶åˆ©ç”¨äº† Cloudflare çš„å…¨çƒè¾¹ç¼˜è®¡ç®—èƒ½åŠ›ã€‚

## æ¶æ„åˆ†ææ€»ç»“

### åŸå§‹ sshx-server æ¶æ„
- **æ ¸å¿ƒç»„ä»¶**: åŸºäº Axum + Tonic çš„æ··åˆæœåŠ¡å™¨
- **çŠ¶æ€ç®¡ç†**: å†…å­˜ä¸­çš„ DashMap å­˜å‚¨ä¼šè¯çŠ¶æ€
- **æŒä¹…åŒ–**: Redis ç”¨äºåˆ†å¸ƒå¼çŠ¶æ€åŒæ­¥å’Œç”¨æˆ·æ•°æ®
- **å®æ—¶é€šä¿¡**: WebSocket ç”¨äºå‰ç«¯ï¼ŒgRPC ç”¨äºå‘½ä»¤è¡Œå®¢æˆ·ç«¯
- **ä¼šè¯ç®¡ç†**: å¤æ‚çš„ä¼šè¯ç”Ÿå‘½å‘¨æœŸå’Œå¿«ç…§æœºåˆ¶

### æ–°çš„ sshx-worker æ¶æ„
- **æ ¸å¿ƒç»„ä»¶**: Cloudflare Workers + Durable Objects
- **çŠ¶æ€ç®¡ç†**: Durable Objects å¤„ç†å®æ—¶çŠ¶æ€ï¼ŒD1 å¤„ç†æŒä¹…åŒ–
- **å®æ—¶é€šä¿¡**: WebSocket API é€‚é… Cloudflare Workers
- **å…¨çƒåˆ†å¸ƒ**: è‡ªåŠ¨éƒ¨ç½²åˆ° Cloudflare çš„å…¨çƒè¾¹ç¼˜ç½‘ç»œ

## å®ç°çš„æ ¸å¿ƒåŠŸèƒ½

### 1. æ•°æ®å±‚ (`db.rs`)
```rust
// å®Œæ•´çš„ D1 æ•°æ®è®¿é—®å±‚
pub struct D1Store {
    db: D1Database,
}

// æ”¯æŒçš„å®ä½“
- User (ç”¨æˆ·ç®¡ç†)
- ApiKey (API å¯†é’¥)
- Session (ä¼šè¯)
- SessionSnapshot (ä¼šè¯å¿«ç…§)
- SessionConnection (è¿æ¥è¿½è¸ª)
```

### 2. ç”¨æˆ·æœåŠ¡ (`user_service.rs`)
```rust
// å®Œæ•´çš„ç”¨æˆ·è®¤è¯å’Œç®¡ç†
- ç”¨æˆ·æ³¨å†Œ/ç™»å½• (bcrypt å¯†ç å“ˆå¸Œ)
- JWT ä»¤ç‰Œç”Ÿæˆå’ŒéªŒè¯
- API å¯†é’¥ç”Ÿæˆå’Œç®¡ç†
- ä¼šè¯æƒé™æ§åˆ¶
```

### 3. ä¼šè¯ç®¡ç† (`session.rs`)
```rust
// ä¼šè¯çŠ¶æ€ç®¡ç†
pub struct SessionState {
    metadata: SessionMetadata,
    shells: HashMap<Sid, ShellState>,
    users: HashMap<Uid, WsUser>,
    counter: IdCounter,
}

// æ ¸å¿ƒåŠŸèƒ½
- ç»ˆç«¯ shell ç®¡ç†
- ç”¨æˆ·çŠ¶æ€åŒæ­¥
- æ•°æ®å—å­˜å‚¨å’Œæ£€ç´¢
- æƒé™æ§åˆ¶
```

### 4. WebSocket åè®® (`protocol.rs`)
```rust
// å®Œå…¨å…¼å®¹åŸå§‹åè®®
pub enum WsServer {
    Hello(Uid, String),
    Users(Vec<(Uid, WsUser)>),
    Shells(Vec<(Sid, WsWinsize)>),
    Chunks(Sid, u64, Vec<Bytes>),
    // ... æ›´å¤šæ¶ˆæ¯ç±»å‹
}

pub enum WsClient {
    Authenticate(Bytes, Option<Bytes>),
    SetName(String),
    Create(i32, i32),
    Data(Sid, Bytes, u64),
    // ... æ›´å¤šæ¶ˆæ¯ç±»å‹
}
```

### 5. Durable Objects (`durable_object.rs`)
```rust
// å®æ—¶ä¼šè¯åè°ƒ
#[durable_object]
pub struct SshxSession {
    state: State,
    session_state: Option<SessionState>,
    websockets: HashMap<Uid, WebSocket>,
}

// æ ¸å¿ƒåŠŸèƒ½
- WebSocket è¿æ¥ç®¡ç†
- å®æ—¶æ¶ˆæ¯å¹¿æ’­
- ä¼šè¯çŠ¶æ€æŒä¹…åŒ–
- ç”¨æˆ·åè°ƒ
```

### 6. WebSocket å¤„ç†å™¨ (`websocket.rs`)
```rust
// WebSocket è¿æ¥å¤„ç†
pub struct WebSocketHandler {
    state: Arc<CloudflareServerState>,
    session_manager: SessionManager,
}

// åŠŸèƒ½
- WebSocket å‡çº§å¤„ç†
- æ¶ˆæ¯åºåˆ—åŒ–/ååºåˆ—åŒ–
- è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†
```

## ä¸»è¦ç‰¹æ€§

### âœ… å®Œå…¨å®ç°çš„åŠŸèƒ½
1. **ç”¨æˆ·è®¤è¯ç³»ç»Ÿ**
   - ç”¨æˆ·æ³¨å†Œå’Œç™»å½•
   - JWT ä»¤ç‰Œè®¤è¯
   - API å¯†é’¥ç®¡ç†
   - æƒé™æ§åˆ¶

2. **ä¼šè¯ç®¡ç†**
   - ä¼šè¯åˆ›å»ºå’Œé”€æ¯
   - å¤šç”¨æˆ·åä½œ
   - å®æ—¶çŠ¶æ€åŒæ­¥
   - ä¼šè¯æŒä¹…åŒ–

3. **WebSocket é€šä¿¡**
   - åè®®å…¼å®¹æ€§
   - å®æ—¶æ¶ˆæ¯ä¼ é€’
   - è¿æ¥ç®¡ç†
   - é”™è¯¯å¤„ç†

4. **ç»ˆç«¯åŠŸèƒ½**
   - Shell åˆ›å»ºå’Œç®¡ç†
   - æ•°æ®æµå¤„ç†
   - çª—å£å¤§å°è°ƒæ•´
   - èŠå¤©åŠŸèƒ½

5. **æ•°æ®æŒä¹…åŒ–**
   - D1 æ•°æ®åº“é›†æˆ
   - ä¼šè¯å¿«ç…§
   - ç”¨æˆ·æ•°æ®å­˜å‚¨
   - è¿æ¥è¿½è¸ª

### ğŸ”§ é…ç½®å’Œéƒ¨ç½²
1. **Cloudflare æœåŠ¡é›†æˆ**
   - D1 æ•°æ®åº“é…ç½®
   - Durable Objects è®¾ç½®
   - KV å­˜å‚¨ (å¯é€‰)
   - R2 å­˜å‚¨ (å¯é€‰)

2. **ç¯å¢ƒé…ç½®**
   - å¼€å‘ç¯å¢ƒè®¾ç½®
   - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
   - ç¯å¢ƒå˜é‡ç®¡ç†
   - æ•°æ®åº“è¿ç§»

## æŠ€æœ¯ä¼˜åŠ¿

### ğŸŒ å…¨çƒåˆ†å¸ƒ
- **è¾¹ç¼˜è®¡ç®—**: ä»£ç åœ¨å…¨çƒ 300+ ä¸ªæ•°æ®ä¸­å¿ƒè¿è¡Œ
- **ä½å»¶è¿Ÿ**: ç”¨æˆ·å°±è¿‘è®¿é—®ï¼Œæ˜¾è‘—é™ä½å»¶è¿Ÿ
- **é«˜å¯ç”¨**: è‡ªåŠ¨æ•…éšœè½¬ç§»å’Œè´Ÿè½½å‡è¡¡

### ğŸ“Š æ€§èƒ½ä¼˜åŒ–
- **å†·å¯åŠ¨ä¼˜åŒ–**: Rust + WASM å¿«é€Ÿå¯åŠ¨
- **å†…å­˜æ•ˆç‡**: ç²¾ç¡®çš„å†…å­˜ç®¡ç†
- **å¹¶å‘å¤„ç†**: å¼‚æ­¥ I/O å’Œäº‹ä»¶é©±åŠ¨æ¶æ„

### ğŸ’° æˆæœ¬æ•ˆç›Š
- **æŒ‰éœ€ä»˜è´¹**: åªä¸ºå®é™…ä½¿ç”¨çš„è®¡ç®—èµ„æºä»˜è´¹
- **æ— æœåŠ¡å™¨**: æ— éœ€ç®¡ç†åŸºç¡€è®¾æ–½
- **è‡ªåŠ¨æ‰©ç¼©**: æ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´

### ğŸ”’ å®‰å…¨æ€§
- **è¾¹ç¼˜å®‰å…¨**: Cloudflare çš„ DDoS é˜²æŠ¤å’Œ WAF
- **æ•°æ®åŠ å¯†**: ä¼ è¾“å’Œå­˜å‚¨æ—¶çš„ç«¯åˆ°ç«¯åŠ å¯†
- **è®¿é—®æ§åˆ¶**: ç»†ç²’åº¦çš„æƒé™ç®¡ç†

## éƒ¨ç½²æŒ‡å—

### 1. ç¯å¢ƒå‡†å¤‡
```bash
# å®‰è£…ä¾èµ–
npm install -g wrangler
cargo install worker-build

# ç™»å½• Cloudflare
wrangler login
```

### 2. æ•°æ®åº“è®¾ç½®
```bash
# åˆ›å»º D1 æ•°æ®åº“
wrangler d1 create sshx

# åˆå§‹åŒ–æ•°æ®åº“ç»“æ„
npm run db:init
```

### 3. é…ç½®æ–‡ä»¶
```toml
# wrangler.toml
name = "sshx-worker"
compatibility_date = "2023-12-01"

[[d1_databases]]
binding = "SSHX_DB"
database_name = "sshx"
database_id = "your-database-id"

[durable_objects]
bindings = [
  { name = "SSHX_SESSION", class_name = "SshxSession" }
]
```

### 4. éƒ¨ç½²
```bash
# æœ¬åœ°å¼€å‘
npm run dev

# éƒ¨ç½²åˆ°ç”Ÿäº§
npm run deploy
```

## å…¼å®¹æ€§ä¿è¯

### ğŸ”„ åè®®å…¼å®¹
- å®Œå…¨å…¼å®¹åŸå§‹ WebSocket åè®®
- æ”¯æŒæ‰€æœ‰ç°æœ‰çš„å®¢æˆ·ç«¯åŠŸèƒ½
- ä¿æŒ API æ¥å£ä¸€è‡´æ€§

### ğŸ¯ åŠŸèƒ½å¯¹ç­‰
- æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½éƒ½å·²å®ç°
- ç”¨æˆ·ä½“éªŒä¿æŒä¸€è‡´
- æ€§èƒ½ç‰¹æ€§å¾—åˆ°æ”¹å–„

## æ‰©å±•èƒ½åŠ›

### ğŸ“ˆ æ°´å¹³æ‰©å±•
- Durable Objects è‡ªåŠ¨åˆ†ç‰‡
- å…¨çƒè´Ÿè½½åˆ†å¸ƒ
- æ— çŠ¶æ€ Worker å®ä¾‹

### ğŸ”Œ é›†æˆèƒ½åŠ›
- ä¸ç°æœ‰ sshx ç”Ÿæ€ç³»ç»Ÿé›†æˆ
- æ”¯æŒç¬¬ä¸‰æ–¹è®¤è¯
- API æ‰©å±•èƒ½åŠ›

## ç›‘æ§å’Œè¿ç»´

### ğŸ“Š å¯è§‚æµ‹æ€§
```bash
# å®æ—¶æ—¥å¿—
npm run logs

# æ€§èƒ½ç›‘æ§
wrangler analytics

# æ•°æ®åº“æŸ¥è¯¢
npm run db:query "SELECT * FROM sessions"
```

### ğŸ› ï¸ ç»´æŠ¤å·¥å…·
- è‡ªåŠ¨å¤‡ä»½
- æ•°æ®åº“è¿ç§»
- é…ç½®ç®¡ç†
- é”™è¯¯è¿½è¸ª

## æ€»ç»“

è¿™æ¬¡è¿ç§»æˆåŠŸåœ°å°† sshx-server çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ç§»æ¤åˆ°äº† Cloudflare Workers å¹³å°ï¼Œå®ç°äº†ï¼š

1. **å®Œæ•´çš„åŠŸèƒ½å¯¹ç­‰**: æ‰€æœ‰åŸå§‹åŠŸèƒ½éƒ½å¾—åˆ°äº†å®ç°
2. **æ¶æ„ç°ä»£åŒ–**: åˆ©ç”¨äº† Cloudflare çš„ç°ä»£è¾¹ç¼˜è®¡ç®—èƒ½åŠ›
3. **æ€§èƒ½æå‡**: å…¨çƒåˆ†å¸ƒå¸¦æ¥çš„ä½å»¶è¿Ÿå’Œé«˜å¯ç”¨æ€§
4. **æˆæœ¬ä¼˜åŒ–**: æŒ‰éœ€ä»˜è´¹çš„æ— æœåŠ¡å™¨æ¶æ„
5. **æ˜“äºç»´æŠ¤**: ç®€åŒ–çš„éƒ¨ç½²å’Œè¿ç»´æµç¨‹

sshx-worker ç°åœ¨å·²ç»å‡†å¤‡å¥½åœ¨ Cloudflare Workers å¹³å°ä¸Šæä¾›é«˜æ€§èƒ½ã€å…¨çƒåˆ†å¸ƒçš„ç»ˆç«¯å…±äº«æœåŠ¡ã€‚